<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein A pH Elution Simulator</title>
    <link rel="icon" href="https://img1.wsimg.com/isteam/ip/022ce7b4-5c08-4de8-8f6a-719b3d06de54/2eb03064-6876-477e-8695-1386705d0e1e.jpg/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:365,h:365,cg:true" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4c63d2 0%, #6c5ce7 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 40px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .controls-panel {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }

        .controls-panel h3 {
            color: #2d3748;
            margin-bottom: 25px;
            font-size: 1.5rem;
            border-bottom: 3px solid #6c5ce7;
            padding-bottom: 10px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h4 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            background: #6c5ce7;
            border-radius: 50%;
            display: inline-block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #6c5ce7;
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .simulate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #6c5ce7 0%, #4c63d2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .simulate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(108, 92, 231, 0.4);
        }

        .simulate-btn:active {
            transform: translateY(-1px);
        }

        .results-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .results-panel h3 {
            color: #2d3748;
            margin-bottom: 25px;
            font-size: 1.5rem;
            border-bottom: 3px solid #6c5ce7;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin: 30px 0;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        .result-card h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .result-card .value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .result-card .unit {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .sequence-analysis {
            background: #f0f9ff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0f2fe;
        }

        .sequence-analysis h4 {
            color: #0c4a6e;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .sequence-display {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            line-height: 1.8;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            font-size: 13px;
            max-height: 150px;
            overflow-y: auto;
        }

        .residue-highlights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .residue-count {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            border: 2px solid #e2e8f0;
            font-weight: 600;
        }

        .histidine { background: linear-gradient(45deg, #ffd93d, #ff6b35); color: white; padding: 3px 5px; border-radius: 4px; font-weight: bold; }
        .asparagine { background: linear-gradient(45deg, #ff6b35, #f7931e); color: white; padding: 3px 5px; border-radius: 4px; font-weight: bold; }
        .glutamine { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; padding: 3px 5px; border-radius: 4px; font-weight: bold; }
        .tyrosine { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 3px 5px; border-radius: 4px; font-weight: bold; }
        .phenylalanine { background: linear-gradient(45deg, #f093fb, #f5576c); color: white; padding: 3px 5px; border-radius: 4px; font-weight: bold; }
        .cysteine { background: linear-gradient(45deg, #ffecd2, #fcb69f); color: #333; padding: 3px 5px; border-radius: 4px; font-weight: bold; }

        .performance-section {
            background: #f0fdf4;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #dcfce7;
            margin-bottom: 20px;
        }

        .performance-section h4 {
            color: #14532d;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #6c5ce7;
            transform: translateY(-2px);
        }

        .metric-card .label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-card .value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #059669;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .warning-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .warning-box h5 {
            color: #92400e;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .warning-box p {
            color: #d97706;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: #6c5ce7;
            cursor: help;
            font-weight: bold;
        }

        .tooltip-content {
            visibility: hidden;
            width: 250px;
            background: #1a202c;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }

        .info-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .parameter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Running Advanced Simulation</h3>
            <p>Calculating molecular interactions and chromatographic behavior...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="https://img1.wsimg.com/isteam/ip/022ce7b4-5c08-4de8-8f6a-719b3d06de54/2eb03064-6876-477e-8695-1386705d0e1e.jpg/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:365,h:365,cg:true" alt="Protein A Logo" class="logo">
                <div>
                    <h1>Protein A pH Elution Simulator</h1>
                    <p>Advanced molecular modeling for antibody purification optimization</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="controls-panel">
                <h3>Simulation Parameters</h3>
                
                <div class="form-section">
                    <h4><span class="section-icon"></span>Ligand Configuration</h4>
                    
                    <div class="form-group">
                        <label for="ligandType">Protein A Variant:</label>
                        <select id="ligandType">
                            <option value="wild_type">Wild-type Protein A</option>
                            <option value="engineered_mild" selected>Engineered (Mild pH)</option>
                            <option value="engineered_harsh">Engineered (Harsh Conditions)</option>
                            <option value="custom_peptide">Custom Peptide Ligand</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ligandFormat">Ligand Format:</label>
                        <select id="ligandFormat">
                            <option value="monomeric">Monomeric</option>
                            <option value="dimeric">Dimeric</option>
                            <option value="tetrameric" selected>Tetrameric</option>
                            <option value="multimeric">Multimeric (>4)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="proteinSeq">Ligand Sequence:
                            <span class="info-tooltip">ℹ️
                                <span class="tooltip-content">Enter the amino acid sequence of your engineered Protein A domain. Key residues (H, N, Q, Y, F, C) will be highlighted and analyzed for their impact on binding and elution properties.</span>
                            </span>
                        </label>
                        <textarea id="proteinSeq" placeholder="Enter your protein/peptide sequence...">VDQKFNKEQQNAFYEILHLPNLNEEQRNAFIQSLKDDPSQSAANLLAEAKKLNDAQAPK</textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h4><span class="section-icon"></span>Target Molecule</h4>
                    
                    <div class="form-group">
                        <label for="targetMolecule">Target Type:</label>
                        <select id="targetMolecule">
                            <option value="human_igg1">Human IgG1</option>
                            <option value="human_igg2">Human IgG2</option>
                            <option value="human_igg4">Human IgG4</option>
                            <option value="mouse_igg1">Mouse IgG1</option>
                            <option value="fc_fusion">Fc-Fusion Protein</option>
                            <option value="fab_fragment">Fab Fragment</option>
                            <option value="bispecific">Bispecific Antibody</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="targetConcentration">Target Concentration (mg/mL):</label>
                        <input type="number" id="targetConcentration" value="2.5" min="0.1" max="20" step="0.1">
                    </div>
                </div>

                <div class="form-section">
                    <h4><span class="section-icon"></span>Chromatography Parameters</h4>
                    
                    <div class="parameter-grid">
                        <div class="form-group">
                            <label for="columnVolume">Column Volume (mL):</label>
                            <input type="number" id="columnVolume" value="1.0" min="0.1" max="50" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="flowRate">Flow Rate (CV/min):</label>
                            <input type="number" id="flowRate" value="2.0" min="0.5" max="10" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="loadingCapacity">Dynamic Binding Capacity (%):</label>
                            <input type="number" id="loadingCapacity" value="80" min="20" max="100" step="5">
                        </div>

                        <div class="form-group">
                            <label for="temperature">Temperature (°C):</label>
                            <input type="number" id="temperature" value="25" min="4" max="37" step="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="elutionStrategy">Elution Strategy:</label>
                        <select id="elutionStrategy">
                            <option value="traditional">Traditional pH Gradient (pH 7.4→2.5)</option>
                            <option value="mild" selected>Mild pH Gradient (pH 7.4→3.5)</option>
                            <option value="step">Step Elution (pH 3.0)</option>
                            <option value="salt_assisted">Salt-Assisted pH Elution</option>
                            <option value="competitive">Competitive Elution</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="gradientTime">Gradient Duration (min):</label>
                        <input type="number" id="gradientTime" value="20" min="5" max="60" step="1">
                    </div>
                </div>

                <button class="simulate-btn" onclick="runAdvancedSimulation()">Run Simulation</button>

                <div class="sequence-analysis">
                    <h4>Molecular Analysis</h4>
                    <div class="sequence-display" id="sequenceDisplay"></div>
                    <div class="residue-highlights" id="residueHighlights"></div>
                </div>

                <div class="performance-section">
                    <h4>Predicted Performance</h4>
                    <div class="metrics-grid" id="performanceMetrics"></div>
                    <div id="warningContainer"></div>
                </div>
            </div>

            <div class="results-panel">
                <h3>📊 Simulation Results</h3>
                <div class="chart-container">
                    <canvas id="elutionChart"></canvas>
                </div>
                
                <div class="results-grid" id="resultsGrid"></div>
            </div>
        </div>
    </div>

    <script>
        let elutionChart = null;
        let currentSimulationData = null;

        // Enhanced molecular constants based on literature
        const MOLECULAR_CONSTANTS = {
            proteinA_pKa: {
                wild_type: { histidine: 6.0, binding_site: 5.8 },
                engineered_mild: { histidine: 6.2, binding_site: 6.0 },
                engineered_harsh: { histidine: 5.8, binding_site: 5.5 }
            },
            antibody_properties: {
                human_igg1: { fc_pKa: 6.1, stability: 0.9, aggregation_tendency: 0.3 },
                human_igg2: { fc_pKa: 6.0, stability: 0.85, aggregation_tendency: 0.4 },
                human_igg4: { fc_pKa: 6.15, stability: 0.8, aggregation_tendency: 0.5 },
                mouse_igg1: { fc_pKa: 5.9, stability: 0.88, aggregation_tendency: 0.35 },
                fc_fusion: { fc_pKa: 6.05, stability: 0.75, aggregation_tendency: 0.6 },
                fab_fragment: { fc_pKa: 6.3, stability: 0.95, aggregation_tendency: 0.2 },
                bispecific: { fc_pKa: 6.0, stability: 0.7, aggregation_tendency: 0.7 }
            },
            binding_constants: {
                base_affinity: 1e8, // M^-1
                temperature_factor: 0.02, // per °C deviation from 25°C
                ionic_strength_factor: 0.1
            }
        };

        function analyzeSequence() {
            const sequence = document.getElementById('proteinSeq').value.toUpperCase().replace(/\s/g, '');
            const ligandFormat = document.getElementById('ligandFormat').value;
            
            if (!sequence || sequence.length < 10) {
                document.getElementById('sequenceDisplay').innerHTML = 
                    '<span style="color: #ef4444;">Please enter a valid protein sequence (minimum 10 residues)</span>';
                return null;
            }

            // Calculate effective sequence based on format
            let effectiveSequence = sequence;
            let domainCount = 1;
            
            const formatMultipliers = {
                'monomeric': 1,
                'dimeric': 2,
                'tetrameric': 4,
                'multimeric': 6
            };
            
            domainCount = formatMultipliers[ligandFormat] || 1;
            if (domainCount > 1) {
                effectiveSequence = sequence.repeat(domainCount);
            }

            // Enhanced residue analysis
            const residueCounts = {
                histidine: (effectiveSequence.match(/H/g) || []).length,
                asparagine: (effectiveSequence.match(/N/g) || []).length,
                glutamine: (effectiveSequence.match(/Q/g) || []).length,
                tyrosine: (effectiveSequence.match(/Y/g) || []).length,
                phenylalanine: (effectiveSequence.match(/F/g) || []).length,
                cysteine: (effectiveSequence.match(/C/g) || []).length,
                tryptophan: (effectiveSequence.match(/W/g) || []).length,
                aspartic: (effectiveSequence.match(/D/g) || []).length,
                glutamic: (effectiveSequence.match(/E/g) || []).length,
                lysine: (effectiveSequence.match(/K/g) || []).length,
                arginine: (effectiveSequence.match(/R/g) || []).length,
                total: effectiveSequence.length
            };

            // Highlight sequence with better visualization
            let highlightedSeq = sequence;
            const highlightMap = {
                'H': 'histidine',
                'N': 'asparagine', 
                'Q': 'glutamine',
                'Y': 'tyrosine',
                'F': 'phenylalanine',
                'C': 'cysteine'
            };

            Object.entries(highlightMap).forEach(([residue, className]) => {
                const regex = new RegExp(residue, 'g');
                highlightedSeq = highlightedSeq.replace(regex, `<span class="${className}">${residue}</span>`);
            });

            // Add domain indicators for multimeric formats
            if (domainCount > 1) {
                highlightedSeq += ` <span style="color: #6b7280; font-style: italic;">×${domainCount} domains</span>`;
            }

            document.getElementById('sequenceDisplay').innerHTML = highlightedSeq;

            // Update residue highlights
            document.getElementById('residueHighlights').innerHTML = `
                <div class="residue-count"><strong>Histidine:</strong> ${residueCounts.histidine}</div>
                <div class="residue-count"><strong>Asparagine:</strong> ${residueCounts.asparagine}</div>
                <div class="residue-count"><strong>Glutamine:</strong> ${residueCounts.glutamine}</div>
                <div class="residue-count"><strong>Aromatic:</strong> ${residueCounts.tyrosine + residueCounts.phenylalanine + residueCounts.tryptophan}</div>
                <div class="residue-count"><strong>Cysteine:</strong> ${residueCounts.cysteine}</div>
                <div class="residue-count"><strong>Total Length:</strong> ${residueCounts.total}</div>
            `;

            return { residueCounts, effectiveSequence, domainCount };
        }

        function calculateAdvancedMetrics(sequenceData) {
            if (!sequenceData) return null;

            const { residueCounts, domainCount } = sequenceData;
            const ligandType = document.getElementById('ligandType').value;
            const targetMolecule = document.getElementById('targetMolecule').value;
            const temperature = parseFloat(document.getElementById('temperature').value);

            // Advanced stability calculations
            const stabilityFactors = {
                histidine: residueCounts.histidine * 3.5, // Protonation stability
                aromatic: (residueCounts.tyrosine + residueCounts.phenylalanine) * 2.1, // Hydrophobic stability
                disulfide: Math.min(residueCounts.cysteine / 2, 4) * 8.0, // Disulfide bonds
                amide: (residueCounts.asparagine + residueCounts.glutamine) * (-1.2), // Deamidation risk
                charge: (residueCounts.lysine + residueCounts.arginine - residueCounts.aspartic - residueCounts.glutamic) * 0.8
            };

            const baseStability = 65 + Object.values(stabilityFactors).reduce((a, b) => a + b, 0);
            const alkalineStability = Math.max(20, Math.min(98, baseStability + (temperature - 25) * (-0.8)));

            // Enhanced binding capacity calculation
            const bindingFactors = {
                base: 75,
                histidine_binding: residueCounts.histidine * 4.5, // Key for protein A binding
                aromatic_interactions: (residueCounts.tyrosine + residueCounts.phenylalanine) * 3.2,
                domain_multiplier: domainCount * 15,
                ligand_type_bonus: ligandType === 'engineered_mild' ? 20 : (ligandType === 'wild_type' ? 0 : 10)
            };

            const dynamicBindingCapacity = Math.min(180, Object.values(bindingFactors).reduce((a, b) => a + b, 0));

            // Aggregation and leakage predictions
            const targetProps = MOLECULAR_CONSTANTS.antibody_properties[targetMolecule];
            const aggregationRisk = Math.max(2, Math.min(45, 
                targetProps.aggregation_tendency * 30 + 
                (temperature > 25 ? (temperature - 25) * 1.2 : 0) +
                (alkalineStability < 70 ? (70 - alkalineStability) * 0.3 : 0)
            ));

            const ligandLeakage = Math.max(0.5, Math.min(15, 
                8 - (alkalineStability / 12) + 
                (residueCounts.asparagine * 0.4) +
                (temperature > 30 ? (temperature - 30) * 0.3 : 0)
            ));

            return {
                alkalineStability: parseFloat(alkalineStability.toFixed(1)),
                dynamicBindingCapacity: parseFloat(dynamicBindingCapacity.toFixed(1)),
                aggregationRisk: parseFloat(aggregationRisk.toFixed(1)),
                ligandLeakage: parseFloat(ligandLeakage.toFixed(2)),
                bindingAffinity: this.calculateBindingAffinity(residueCounts, targetMolecule, temperature),
                elutionSharpness: this.calculateElutionSharpness(residueCounts, ligandType)
            };
        }

        function calculateBindingAffinity(residueCounts, targetMolecule, temperature) {
            const baseAffinity = MOLECULAR_CONSTANTS.binding_constants.base_affinity;
            const targetProps = MOLECULAR_CONSTANTS.antibody_properties[targetMolecule];
            
            // pH-dependent binding strength
            const histidineContribution = residueCounts.histidine * 1.5;
            const aromaticContribution = (residueCounts.tyrosine + residueCounts.phenylalanine) * 1.2;
            const temperatureFactor = Math.exp(-MOLECULAR_CONSTANTS.binding_constants.temperature_factor * (temperature - 25));
            
            const effectiveAffinity = baseAffinity * (1 + histidineContribution / 100) * 
                                    (1 + aromaticContribution / 100) * temperatureFactor * targetProps.stability;
            
            return Math.min(9.9e8, Math.max(1e6, effectiveAffinity));
        }

        function calculateElutionSharpness(residueCounts, ligandType) {
            const baseSigma = 0.3; // pH units
            const histidineFactor = Math.min(2.0, residueCounts.histidine * 0.1);
            const ligandFactor = ligandType === 'engineered_mild' ? 0.8 : 1.0;
            
            return parseFloat((baseSigma * histidineFactor * ligandFactor).toFixed(2));
        }

        function generateElutionProfile(sequenceData, parameters) {
            if (!sequenceData) return [];

            const { residueCounts } = sequenceData;
            const elutionStrategy = parameters.elutionStrategy;
            const gradientTime = parameters.gradientTime;
            const ligandType = parameters.ligandType;
            const targetMolecule = parameters.targetMolecule;
            const temperature = parameters.temperature;

            // Define pH ranges based on strategy
            const pHRanges = {
                'traditional': { start: 7.4, end: 2.5, steps: 150 },
                'mild': { start: 7.4, end: 3.5, steps: 120 },
                'step': { start: 7.4, end: 3.0, steps: 50 },
                'salt_assisted': { start: 7.4, end: 3.2, steps: 100 },
                'competitive': { start: 7.4, end: 4.0, steps: 80 }
            };

            const range = pHRanges[elutionStrategy];
            const dataPoints = [];
            const targetProps = MOLECULAR_CONSTANTS.antibody_properties[targetMolecule];
            const ligandProps = MOLECULAR_CONSTANTS.proteinA_pKa[ligandType] || MOLECULAR_CONSTANTS.proteinA_pKa.wild_type;

            // Calculate elution parameters
            const elutionPH = this.calculateOptimalElutionPH(residueCounts, ligandType, targetMolecule);
            const peakWidth = this.calculateElutionSharpness(residueCounts, ligandType);
            const maxIntensity = Math.min(150, 50 + residueCounts.histidine * 8 + (parameters.targetConcentration * 10));

            for (let i = 0; i <= range.steps; i++) {
                const progress = i / range.steps;
                const currentPH = range.start - progress * (range.start - range.end);
                const timeMinutes = progress * gradientTime;

                // Advanced binding model based on Henderson-Hasselbalch and protein A mechanism
                let bindingStrength = 1.0;
                
                // Histidine protonation effect (major factor)
                const histidineProtonation = residueCounts.histidine > 0 ? 
                    Math.pow(10, ligandProps.histidine - currentPH) / (1 + Math.pow(10, ligandProps.histidine - currentPH)) : 0;
                
                // Fc binding site protonation
                const fcProtonation = Math.pow(10, targetProps.fc_pKa - currentPH) / (1 + Math.pow(10, targetProps.fc_pKa - currentPH));
                
                // Electrostatic repulsion calculation
                const electrostaticRepulsion = histidineProtonation * fcProtonation * 2.0;
                
                // Hydrophobic contributions (less pH sensitive)
                const hydrophobicContribution = (residueCounts.tyrosine + residueCounts.phenylalanine) * 0.03 * 
                    (1 - electrostaticRepulsion * 0.5);

                bindingStrength = Math.max(0, 1 - electrostaticRepulsion + hydrophobicContribution);

                // Calculate elution intensity (inverse of binding strength)
                let elutionIntensity = 0;
                if (bindingStrength < 0.5) {
                    // Gaussian-like elution peak centered at optimal pH
                    const pHDeviation = currentPH - elutionPH;
                    elutionIntensity = maxIntensity * Math.exp(-(pHDeviation * pHDeviation) / (2 * peakWidth * peakWidth)) * 
                                     (1 - bindingStrength);
                    
                    // Add tailing effects for harsh conditions
                    if (elutionStrategy === 'traditional' && currentPH < elutionPH) {
                        elutionIntensity += maxIntensity * 0.1 * Math.exp(-Math.abs(pHDeviation) / 0.5);
                    }
                }

                // Temperature effects
                const tempFactor = 1 + (temperature - 25) * 0.015;
                elutionIntensity *= tempFactor;

                // Add realistic noise
                elutionIntensity += (Math.random() - 0.5) * 2;
                elutionIntensity = Math.max(0, elutionIntensity);

                dataPoints.push({
                    time: parseFloat(timeMinutes.toFixed(2)),
                    pH: parseFloat(currentPH.toFixed(2)),
                    intensity: parseFloat(elutionIntensity.toFixed(2)),
                    bindingStrength: parseFloat(bindingStrength.toFixed(3))
                });
            }

            return dataPoints;
        }

        function calculateOptimalElutionPH(residueCounts, ligandType, targetMolecule) {
            const ligandProps = MOLECULAR_CONSTANTS.proteinA_pKa[ligandType] || MOLECULAR_CONSTANTS.proteinA_pKa.wild_type;
            const targetProps = MOLECULAR_CONSTANTS.antibody_properties[targetMolecule];
            
            // Base elution pH influenced by histidine content and target properties
            const baseElutionPH = ligandProps.binding_site - 0.5;
            const histidineAdjustment = residueCounts.histidine * 0.1;
            const targetAdjustment = (targetProps.fc_pKa - 6.0) * 0.5;
            
            return Math.max(2.8, Math.min(5.5, baseElutionPH - histidineAdjustment + targetAdjustment));
        }

        function findElutionPeak(dataPoints) {
            let maxIntensity = 0;
            let peakData = { time: 0, pH: 7.0, intensity: 0 };
            
            dataPoints.forEach(point => {
                if (point.intensity > maxIntensity) {
                    maxIntensity = point.intensity;
                    peakData = { ...point };
                }
            });

            // Calculate peak characteristics
            const halfMax = maxIntensity / 2;
            let peakStart = peakData.time;
            let peakEnd = peakData.time;
            
            // Find FWHM
            for (let i = 0; i < dataPoints.length; i++) {
                if (dataPoints[i].intensity >= halfMax) {
                    if (dataPoints[i].time < peakData.time) {
                        peakStart = dataPoints[i].time;
                    }
                    if (dataPoints[i].time > peakData.time) {
                        peakEnd = dataPoints[i].time;
                        break;
                    }
                }
            }

            const peakWidth = peakEnd - peakStart;

            return {
                ...peakData,
                peakWidth: parseFloat(peakWidth.toFixed(2))
            };
        }

        function updatePerformanceMetrics(metrics, warnings = []) {
            if (!metrics) return;

            const metricsHtml = `
                <div class="metric-card">
                    <div class="label">Alkaline Stability</div>
                    <div class="value">${metrics.alkalineStability}%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Binding Capacity</div>
                    <div class="value">${metrics.dynamicBindingCapacity}</div>
                </div>
                <div class="metric-card">
                    <div class="label">Aggregation Risk</div>
                    <div class="value">${metrics.aggregationRisk}%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Ligand Leakage</div>
                    <div class="value">${metrics.ligandLeakage} μg/mL</div>
                </div>
                <div class="metric-card">
                    <div class="label">Binding Affinity</div>
                    <div class="value">${(metrics.bindingAffinity / 1e8).toFixed(1)}×10⁸</div>
                </div>
                <div class="metric-card">
                    <div class="label">Peak Width</div>
                    <div class="value">${metrics.elutionSharpness} pH</div>
                </div>
            `;

            document.getElementById('performanceMetrics').innerHTML = metricsHtml;

            // Show warnings if any
            const warningContainer = document.getElementById('warningContainer');
            if (warnings.length > 0) {
                const warningsHtml = warnings.map(warning => `
                    <div class="warning-box">
                        <h5>⚠️ ${warning.title}</h5>
                        <p>${warning.message}</p>
                    </div>
                `).join('');
                warningContainer.innerHTML = warningsHtml;
            } else {
                warningContainer.innerHTML = '';
            }
        }

        function updateElutionChart(data, peakInfo) {
            const ctx = document.getElementById('elutionChart').getContext('2d');
            
            if (elutionChart) {
                elutionChart.destroy();
            }

            const maxIntensity = Math.max(...data.map(d => d.intensity));
            
            elutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.time),
                    datasets: [
                        {
                            label: 'Antibody Elution (A280 nm)',
                            data: data.map(d => d.intensity),
                            borderColor: 'rgb(108, 92, 231)',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 8,
                            borderWidth: 3
                        },
                        {
                            label: 'pH Gradient',
                            data: data.map(d => d.pH * (maxIntensity / 8)), // Scale for visibility
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Binding Strength',
                            data: data.map(d => d.bindingStrength * maxIntensity),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.05)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0,
                            borderWidth: 2,
                            borderDash: [3, 3]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: '600' }
                            }
                        },
                        title: {
                            display: true,
                            text: `Predicted Chromatogram - Peak at pH ${peakInfo.pH} (${peakInfo.time} min)`,
                            font: { size: 16, weight: 'bold' },
                            color: '#1f2937'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(108, 92, 231, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    return `Time: ${context[0].label} min`;
                                },
                                label: function(context) {
                                    const point = data[context.dataIndex];
                                    if (context.datasetIndex === 0) {
                                        return `Elution: ${context.parsed.y.toFixed(1)} mAU`;
                                    } else if (context.datasetIndex === 1) {
                                        return `pH: ${point.pH}`;
                                    } else {
                                        return `Binding: ${point.bindingStrength.toFixed(3)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time (minutes)',
                                font: { size: 14, weight: '600' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Absorbance (mAU) / Binding Strength',
                                font: { size: 14, weight: '600' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'pH (scaled)',
                                font: { size: 14, weight: '600' }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function generateWarnings(metrics, peakInfo, parameters) {
            const warnings = [];

            if (metrics.aggregationRisk > 25) {
                warnings.push({
                    title: 'High Aggregation Risk',
                    message: `Aggregation risk is ${metrics.aggregationRisk}%. Consider using milder elution conditions or adding stabilizers.`
                });
            }

            if (peakInfo.pH < 3.2) {
                warnings.push({
                    title: 'Harsh Elution Conditions',
                    message: `Elution pH of ${peakInfo.pH} may cause protein degradation. Consider engineered ligands for milder conditions.`
                });
            }

            if (metrics.ligandLeakage > 8) {
                warnings.push({
                    title: 'High Ligand Leakage',
                    message: `Predicted ligand leakage of ${metrics.ligandLeakage} μg/mL exceeds recommended levels. Check ligand stability.`
                });
            }

            if (metrics.dynamicBindingCapacity < 60) {
                warnings.push({
                    title: 'Low Binding Capacity',
                    message: `Binding capacity of ${metrics.dynamicBindingCapacity} mg/mL is below typical ranges. Optimize ligand density.`
                });
            }

            if (parameters.temperature > 30) {
                warnings.push({
                    title: 'Elevated Temperature',
                    message: `Operating temperature of ${parameters.temperature}°C may reduce stability and increase aggregation.`
                });
            }

            return warnings;
        }

        function runAdvancedSimulation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            setTimeout(() => {
                try {
                    // Get current parameters
                    const parameters = {
                        ligandType: document.getElementById('ligandType').value,
                        ligandFormat: document.getElementById('ligandFormat').value,
                        targetMolecule: document.getElementById('targetMolecule').value,
                        targetConcentration: parseFloat(document.getElementById('targetConcentration').value),
                        columnVolume: parseFloat(document.getElementById('columnVolume').value),
                        flowRate: parseFloat(document.getElementById('flowRate').value),
                        loadingCapacity: parseFloat(document.getElementById('loadingCapacity').value),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        elutionStrategy: document.getElementById('elutionStrategy').value,
                        gradientTime: parseFloat(document.getElementById('gradientTime').value)
                    };

                    // Analyze sequence
                    const sequenceData = analyzeSequence();
                    if (!sequenceData) {
                        throw new Error('Invalid sequence data');
                    }

                    // Calculate metrics
                    const metrics = calculateAdvancedMetrics(sequenceData);
                    
                    // Generate elution profile
                    const elutionData = generateElutionProfile(sequenceData, parameters);
                    const peakInfo = findElutionPeak(elutionData);
                    
                    // Calculate additional results
                    const recoveryYield = Math.min(98, Math.max(70, 90 - metrics.aggregationRisk * 0.5));
                    const purity = Math.min(99.5, Math.max(85, 95 - (metrics.ligandLeakage * 2)));
                    const productivity = (parameters.targetConcentration * parameters.columnVolume * recoveryYield / 100) / (parameters.gradientTime / 60);
                    
                    // Store simulation data
                    currentSimulationData = {
                        sequenceData,
                        parameters,
                        metrics,
                        elutionData,
                        peakInfo,
                        recoveryYield,
                        purity,
                        productivity
                    };

                    // Update displays
                    updatePerformanceMetrics(metrics, generateWarnings(metrics, peakInfo, parameters));
                    updateElutionChart(elutionData, peakInfo);
                    updateResultsGrid(currentSimulationData);

                } catch (error) {
                    console.error('Simulation error:', error);
                    alert('Simulation failed. Please check your inputs and try again.');
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }, 2000);
        }

        function updateResultsGrid(simData) {
            const { metrics, peakInfo, recoveryYield, purity, productivity, parameters } = simData;
            
            const resultsHtml = `
                <div class="result-card">
                    <h4>Elution Peak pH</h4>
                    <div class="value">${peakInfo.pH}</div>
                    <div class="unit">pH units</div>
                </div>
                <div class="result-card">
                    <h4>Peak Time</h4>
                    <div class="value">${peakInfo.time}</div>
                    <div class="unit">minutes</div>
                </div>
                <div class="result-card">
                    <h4>Peak Intensity</h4>
                    <div class="value">${peakInfo.intensity.toFixed(1)}</div>
                    <div class="unit">mAU</div>
                </div>
                <div class="result-card">
                    <h4>Recovery Yield</h4>
                    <div class="value">${recoveryYield.toFixed(1)}</div>
                    <div class="unit">%</div>
                </div>
                <div class="result-card">
                    <h4>Product Purity</h4>
                    <div class="value">${purity.toFixed(1)}</div>
                    <div class="unit">%</div>
                </div>
                <div class="result-card">
                    <h4>Productivity</h4>
                    <div class="value">${productivity.toFixed(2)}</div>
                    <div class="unit">mg/h</div>
                </div>
                <div class="result-card">
                    <h4>Peak Width</h4>
                    <div class="value">${peakInfo.peakWidth}</div>
                    <div class="unit">minutes</div>
                </div>
            `;

            document.getElementById('resultsGrid').innerHTML = resultsHtml;
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('proteinSeq').addEventListener('input', analyzeSequence);
            document.getElementById('ligandFormat').addEventListener('change', analyzeSequence);
            
            // Initial analysis
            analyzeSequence();
            
            // Run initial simulation
            setTimeout(() => {
                runAdvancedSimulation();
            }, 500);
        });
    </script>
</body>
</html>
